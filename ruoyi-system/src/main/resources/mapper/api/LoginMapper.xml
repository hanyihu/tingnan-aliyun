<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ruoyi.api.mapper.LoginMapper">
    

    <sql id="SysUserVo">
       user_id as userId,
       dept_id as deptId,
       cid as cId,
       login_name as loginName,
       user_name as userName,
       email as email,
       phonenumber as phonenumber,
       sex as sex,
       avatar as avatar,
       password as password,
       salt as salt,
       status as status,
       del_flag as delFlag,
       login_ip as loginIp,
       login_date as loginDate,
       create_time as createTime
    </sql>

    <!--注册用户信息-->
    <insert id="insertUserInfo" parameterType="com.ruoyi.system.domain.SysUser" useGeneratedKeys="true"
            keyProperty="userId">
        insert into sys_user(

        <if test="deptId != null and deptId != ''">dept_id,</if>

        <if test="loginName != null and loginName != ''">login_name,</if>
        <if test="userName != null and userName != ''">user_name,</if>

        <if test="loginName != null and loginName != ''">phonenumber,</if>
        <if test="sex != null and sex != ''">sex,</if>
        <if test="avatar != null and avatar != ''">avatar,</if>
        <if test="password != null and password != ''">password,</if>
        <if test="salt != null and salt != ''">salt,</if>

        <if test="delFlag != null and delFlag != ''">del_flag,</if>
        <if test="loginIp != null and loginIp != ''">login_ip,</if>
        <if test="loginDate != null and loginDate != ''">login_date,</if>
        create_time
        )values(

        <if test="deptId != null and deptId != ''">#{deptId},</if>

        <if test="loginName != null and loginName != ''">#{loginName},</if>
        <if test="userName != null and userName != ''">#{userName},</if>

        <if test="loginName != null and loginName != ''">#{loginName},</if>
        <if test="sex != null and sex != ''">#{sex},</if>
        <if test="avatar != null and avatar != ''">#{avatar},</if>
        <if test="password != null and password != ''">#{password},</if>
        <if test="salt != null and salt != ''">#{salt},</if>

        <if test="delFlag != null and delFlag != ''">#{delFlag},</if>
        <if test="loginIp != null and loginIp != ''">#{loginIp},</if>
        <if test="loginDate != null and loginDate != ''">#{loginDate},</if>
        GETDATE()
        )
    </insert>

    <!--插入角色id-->
    <insert id="insertUserRole">
        insert into sys_user_role(user_id,role_id)
    values (#{userId},#{roleId})
    </insert>

    <!--通过登录张号修改密码-->
    <update id="updatePasswordByLoginName">
        update sys_user set password = #{password} where login_name = #{loginName}
    </update>

    <update id="updatecId">
         update sys_user set cid = #{cId} where user_id = #{userId}
    </update>

    <!-- 验证登录用户 -->
    <select id="login" resultType="com.ruoyi.system.domain.SysUser">
      select
       <include refid="SysUserVo"/>
      from sys_user
      <where>
          <if test="loginName != null and loginName != ''">
              login_name = #{loginName}
          </if>
          <if test="password != null and password != ''">
            and  password = #{password}
          </if>

      </where>

    </select>

    <!--根据用户账号获取用户信息-->
   <select id="getUserInfor" resultType="com.ruoyi.system.domain.SysUser">
       select
       <include refid="SysUserVo"/>
       from sys_user
       <where>
           <if test="loginName != null and loginName != ''">
               login_name = #{loginName}
           </if>

       </where>
   </select>

    <select id="getUserRole" resultType="com.ruoyi.system.domain.SysUserRole">
        select user_id as userId , role_id as roleId
        from sys_user_role
        where user_id = #{userId}
        order by role_id desc
    </select>


</mapper>